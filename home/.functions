# Create a new directory and enter it
function mkd() {
  mkdir -p "$@" && cd "$_";
}

# create a file and parent directories
# mkfile "foo/bar/baz.txt"
function mkfile() {
  mkdir -p -- $(dirname "$1") && touch -- "$1"
}

# Determine size of a file or total size of a directory
function fs() {
  if du -b /dev/null > /dev/null 2>&1; then
    local arg=-sbh;
  else
    local arg=-sh;
  fi
  if [[ -n "$@" ]]; then
    du $arg -- "$@";
  else
    du $arg .[^.]* ./*;
  fi;
}

function get-current-branch-name {
  git branch --show-current 2>/dev/null || echo ""
}

# `tre` is a shorthand for `tree` with hidden files and color enabled, ignoring
# the `.git` directory, listing directories first. The output gets piped into
# `less` with options to preserve color and line numbers, unless the output is
# small enough for one screen.
function tre() {
  tree -aC -I '.git|node_modules|dist|build|target|coverage' --dirsfirst "$@" | less -FRNX;
}

# run `fnm use` with the provided version
function set-node-version() {
  local global_npm_package_names
  global_npm_package_names=$(npm ls --depth=0 --json -g | jq -r '.dependencies? | keys? | .[]' | grep -v '^npm$')
  echo "fnm use $1"
  fnm use "$1"
  echo "npm install -g $(echo "$global_npm_package_names" | tr '\n' ' ')"
  if [ -n "$global_npm_package_names" ]; then
    echo "$global_npm_package_names" | xargs npm install -g
  fi
}

# Function to set tab title and a one-time random tab color
function set_terminal_appearance() {
  # 1. Set the Title (Current directory)
  echo -ne "\e]1;${PWD##*/}\a"

  # 2. Set a Unique Color (Only if not already set for this session)
  if [[ -z "$TAB_COLOR_SET" ]]; then
    # Generate random values between 0-255
    local r=$(( RANDOM % 256 ))
    local g=$(( RANDOM % 256 ))
    local b=$(( RANDOM % 256 ))

    # Apply iTerm2 escape sequences
    echo -ne "\033]6;1;bg;red;brightness;$r\a"
    echo -ne "\033]6;1;bg;green;brightness;$g\a"
    echo -ne "\033]6;1;bg;blue;brightness;$b\a"

    # Mark as set so it doesn't change every time you cd
    export TAB_COLOR_SET=1
  fi
}

# Execute before every prompt
autoload -Uz add-zsh-hook
add-zsh-hook precmd set_terminal_appearance
